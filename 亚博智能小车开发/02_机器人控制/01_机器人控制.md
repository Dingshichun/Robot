# 机器人控制
小车连接上代理后，会发布雷达、imu 等传感器数据，可以查询这些信息，也可以发布速度、蜂鸣器等传感器的控制数据。  
**注意**：虚拟机需要与小车处在同一个局域网下，且 ROS_DOMAIN_ID 需要一致，参考教程进行设置。
### (1) 机器人信息发布
1. **查询小车节点信息**  
首先要确保小车连接了代理，使用配套的虚拟机，在终端运行 `sh ~/start_agent_computer.sh` ，且保持该命令的运行。  
重新打开一个终端，输入 `ros2 node list` 查询节点，应该显示 /YB_Car_Node ，输入 `ros2 node info /YB_Car_Node` 查询该节点订阅和发布了哪些话题，也可以通过话题查询命令 `ros2 topic list` 查询话题，一般查询到的话题如下：
```
订阅的话题有，
/beep：蜂鸣器控制
/cmd_vel：小车速度控制
/servo_s1：s1舵机云台控制
/servo_s2：s1舵机云台控制
发布的话题有，
/imu：imu模块数据
/odom：里程计模块数据
/scan：雷达模块数据
```
查询话题数据命令
```
ros2 topic echo /scan # 查询雷达
ros2 topic echo /odom_raw # 查询里程计模块
ros2 topic echo /imu # 查询惯性测量单元
```
2. **发布小车控制信息**   
比如蜂鸣器，首先要查询蜂鸣器的数据类型，终端输入  
`ros2 topic info /beep`  
查询到数据类型是 std_msgs/msg/UInt16 ，然后输入控制蜂鸣器的指令，如下  
```
ros2 topic pub /beep std_msgs/msg/UInt16 "data: 1"  # 打开蜂鸣器
ros2 topic pub /beep std_msgs/msg/UInt16 "data: 0"  # 关闭蜂鸣器
```  
比如速度控制 cmd_vel 的数据类型，终端输入  
`ros2 topic info /cmd_vel`  
查询到数据类型是 geometry_msgs/msg/Twist ，输入控制指令
```
# 布小车以线速度 0.1 的速度，角速度 0.1 运动
ros2 topic pub /cmd_vel geometry_msgs/msg/Twist "{linear:{x: 0.1, y: 0.0, z:
0.0},angular:{x: 0.0, y: 0.0, z: 0.1}}"

# 停车则参数全设为 0 即可 
ros2 topic pub /cmd_vel geometry_msgs/msg/Twist "{linear:{x: 0.0, y: 0.0, z:
0.0},angular:{x: 0.0, y: 0.0, z: 0.0}}"
```

比如控制云台舵机 servo ，需要注意的是 s1 舵机的转动范围是[-90,90]，s2 舵机的转动范围是[-90,20]，超过范围的值，舵机不转动。
```
ros2 topic pub /servo_s1 std_msgs/msg/Int32 "data: 30" # s1 舵机转 30°
ros2 topic pub /servo_s2 std_msgs/msg/Int32 "data: -45" # s2 舵机转 -45°
```
### (2) 机器人键盘控制
步骤如下：
```
# 1.连接代理。打开终端，输入
sh ~/start_agent_computer.sh
# 2.启动键盘控制程序。新开一个终端，输入
ros2 run yahboomcar_ctrl yahboom_keyboard
```
还可以进行手柄控制，详见教程。

### (3) 机器人状态估计
首先小车要连接代理，终端输入 `sh ~/start_agent_computer.sh`  
然后重新打开终端，输入 `ros2 launch yahboomcar_bringup yahboomcar_bringup_launch.py` 启动程序。  
然后再新开终端，输入 `ros2 run rqt_graph rqt_graph` 查看节点间的通讯图，如果一开始没有显示，进行刷新。由通讯图可知，融合节点为 /ekf_filter_node ，输入命令 `ros2 node info /ekf_filter_node` 查看该节点信息。  
yahboomcar_bringup_launch.py 文件见 source 文件夹。
### (4) 线速度和角速度标定
1. 线速度标定  
首先打开一个终端连接代理，输入 `sh ~/start_agent_computer.sh` 启动代理。  
启动小车处理底层数据程序，该程序会发布 odom->base_footprint 的 TF 变换，有了这个 TF 变化可以计算出“小车走了多远”，新打开一个终端，输入  
`ros2 launch yahboomcar_bringup yahboomcar_bringup_launch.py`  
再打开一个终端，启动小车线速度标定程序，输入 `ros2 run yahboomcar_bringup calibrate_linear`  
打开动态参数调节器，新开一个终端，输入 `ros2 run rqt_reconfigure rqt_reconfigure` ，会打开一个参数调节界面，先刷新左侧的节点页面，才会出现 calibrate_linear 节点，点击，然后再右侧查找 start_test 按钮，勾选即可开始标定。  
2. 角速度标定  
类似角速度标定，如下
```
# 1.打开新终端，启动代理
sh ~/start_agent_computer.sh
# 2.启动小车处理底层数据程序，该程序会发布 odom->base_footprint 的 TF 变换，有了这个 TF 变化接可以计算出“小车转了多少度”，新开终端，输入
ros2 launch yahboomcar_bringup yahboomcar_bringup_launch.py
# 3.启动小车角速度标定程序，新开终端，输入
ros2 run yahboomcar_bringup calibrate_angular
# 4.打开动态参数调节器，新开终端，输入
ros2 run rqt_reconfigure rqt_reconfigure

# 后续操作类似角速度标定，参考线速度标定即可。
```
### (5) 机器人 URDF(Unified Robot Description Format,统一机器人描述性格式) 模型
小车连接上代理，运行程序，rviz 中会显示 URDF 模型。   
```
# 1.加载 URDF 和生成一个模拟控制器，新建终端，输入
ros2 launch yahboomcar_description display_launch.py
# 2.打开 rivz 显示模型，终端输入
rviz2
将【Fixed Frame】改成 base_link，即可显示小车模型，

# 3.然后，用鼠标调整视角，滑动刚才生成的模拟控制器，即可看的小车的轮胎/相机在变化，
```